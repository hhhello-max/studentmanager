<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>成绩列表</title>
    <link rel="stylesheet" type="text/css" th:href="@{/easyui/themes/default/easyui.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/easyui/themes/icon.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/easyui/css/demo.css}">
    <script type="text/javascript" th:src="@{/easyui/jquery.min.js}"></script>
    <script type="text/javascript" th:src="@{/easyui/jquery.easyui.min.js}"></script>
    <script type="text/javascript" th:src="@{/easyui/js/validateExtends.js}"></script>
    <script type="text/javascript" th:inline="javascript">
        /*<![CDATA[*/
        $(function () {
            //datagrid初始化
            $('#dataList').datagrid({
                title: '成绩信息列表',
                iconCls: 'icon-more',//图标
                border: true,
                collapsible: false,//是否可折叠的
                fit: true,//自动大小
                method: "post",
                url: [[@{/score/getScoreList}]],
                singleSelect:false,//是否单选
                pagination:true,//分页控件
                rownumbers:true,//行号
                sortOrder:'DESC',
                remoteSort:false,
                columns:[
                       [
                    {field: 'chk', checkbox: true, width: 50},
                    {field: 'sn', title: '学号', width: 200,sortable: true},
                    {field: 'course', title: '课程', width: 200},
                    {field: 'grade', title: '分数', width: 150},
                    {field: 'credit', title: '学分', width: 150},
                    {field: 'point', title: '绩点', width: 150}
                   ]
                  ],
                toolbar:"#toolbar",
            });

            //设置分页控件
            var p = $('#dataList').datagrid('getPager');
            $(p).pagination({
                pageSize: 10,//每页显示的记录条数，默认为10
                pageList: [10, 20, 30, 50, 100],//可以设置每页记录条数的列表
                beforePageText: '第',//页数文本框前显示的汉字
                afterPageText: '页    共 {pages} 页',
                displayMsg: '当前显示 {from} - {to} 条记录   共 {total} 条记录',
            });

            //设置工具类按钮
            $("#add").click(function () {
                $("#addDialog").dialog("open");
            });

            //设置导入工具类按钮
            $("#import").click(function () {
                $("#importDialog").dialog("open");
            });

            $("#set").click(function () {
                $("#setDialog").dialog('open');
            });

            //修改
            $("#edit").click(function(){
                var selectRows = $("#dataList").datagrid("getSelections");
                if(selectRows.length !== 1){
                    $.messager.alert("消息提醒", "请选择一条数据进行操作!", "warning");
                } else{
                    $("#editDialog").dialog("open");
                }
            });

            $("#setDialog").dialog({
                title:"设置基本的条件",
                width: 450,
                height: 450,
                iconCls: "icon-add",
                modal: true,
                collapsible: false,
                minimizable: false,
                maximizable: false,
                draggable: true,
                closed: true,
                buttons: [
                    {
                        text: '提交',
                        plain: true,
                        iconCls: 'icon-book-add',
                        handler: function () {
                            var validate = $("#setForm").form("validate");
                            if (!validate) {
                                $.messager.alert("消息提醒", "请检查你输入的数据!", "warning");

                            } else {
                                $.ajax({
                                    type: "post",
                                    url: [[@{/candidate/addCandidate}]],
                                    data: $("#setForm").serialize(),
                                    success:function (data) {
                                    if (data.success) {
                                        $.messager.alert("消息提醒", data.message, "info");
                                        //关闭窗口
                                        $("#setDialog").dialog("close");
                                        //刷新
                                        $('#dataList').datagrid("reload");
                                    } else {
                                        $.messager.alert("消息提醒", data.message, "warning");

                                    }
                                }
                            });
                            }
                        }
                    },
                ]
            });

            //删除
            $("#delete").click(function () {
                var selectRow = $("#dataList").datagrid("getSelected");
                if (selectRow == null) {
                    $.messager.alert("消息提醒", "请选择数据进行删除!", "warning");
                } else {
                    var id = selectRow.id;
                    $.messager.confirm("消息提醒", "确定删除成绩么，确认继续？", function (r) {
                        if (r) {
                            $.ajax({
                                type: "post",
                                url: [[@{/score/deleteScore}]],
                                data:{id: id},
                                success: function (data) {
                                if (data.success) {
                                    $.messager.alert("消息提醒", data.message, "info");
                                    //刷新表格
                                    $("#dataList").datagrid("reload");
                                } else {
                                    $.messager.alert("消息提醒", data.message, "warning");
                                    return;
                                }
                            }
                        })
                            ;
                        }
                    });
                }
            });

            //设置添加窗口
            $("#addDialog").dialog({
                title: "添加成绩信息",
                width: 450,
                height: 450,
                iconCls: "icon-add",
                modal: true,
                collapsible: false,
                minimizable: false,
                maximizable: false,
                draggable: true,
                closed: true,
                buttons: [
                    {
                        text: '添加',
                        plain: true,
                        iconCls: 'icon-book-add',
                        handler: function () {
                            var validate = $("#addForm").form("validate");
                            if (!validate) {
                                $.messager.alert("消息提醒", "请检查你输入的数据!", "warning");
                                return;
                            } else {
                                $.ajax({
                                    type: "post",
                                    url: [[@{/score/addScore}]],
                                data: $("#addForm").serialize(),
                                    success:function (data) {
                                    if (data.success) {
                                        $.messager.alert("消息提醒", data.message, "info");
                                        //关闭窗口
                                        $("#addDialog").dialog("close");
                                        //刷新
                                        $('#dataList').datagrid("reload");
                                    } else {
                                        $.messager.alert("消息提醒", data.message, "warning");
                                        return;
                                    }
                                }
                            });
                            }
                        }
                    },
                    {
                        text: '重置',
                        plain: true,
                        iconCls: 'icon-book-reset',
                        handler: function () {
                            // $("#add_remark").textbox('setValue', "");
                        }
                    },
                ]
            });

            //设置修改窗口
            $("#editDialog").dialog({
                title: "修改成绩信息",
                width: 450,
                height: 450,
                iconCls: "icon-edit",
                modal: true,
                collapsible: false,
                minimizable: false,
                maximizable: false,
                draggable: true,
                closed: true,
                buttons: [
                    {
                        text: '修改',
                        plain: true,
                        iconCls: 'icon-mini-edit',
                        handler: function () {
                            var validate = $("#editForm").form("validate");
                            if (!validate) {
                                $.messager.alert("消息提醒", "请检查你输入的数据!", "warning");

                            } else {

                                $.ajax({
                                    type: "post",
                                    url: [[@{/score/editScore}]],
                                    data: $("#editForm").serialize(),
                                    success:function (data) {
                                    if (data.success) {
                                        $.messager.alert("消息提醒", data.message, "info");
                                        //关闭窗口
                                        $("#editDialog").dialog("close");

                                        //刷新
                                        $('#dataList').datagrid("reload");
                                    } else {
                                        $.messager.alert("消息提醒", data.message, "warning");
                                        return;
                                    }
                                }
                            });
                            }
                        }
                    },
                    {
                        text: '重置',
                        plain: true,
                        iconCls: 'icon-book-reset',
                        handler: function () {
                            $("#edit_course").numberbox('setValue','');
                            $("#edit_grade").textbox('setValue', '');
                            $("#edit_credit").numberbox('setValue', '');
                            $("#edit_point").textbox('setValue', '');
                        }
                    },
                ],
                onBeforeOpen: function () {
                    var selectRow = $("#dataList").datagrid("getSelected");
                    //设置值
                    $("#edit_sn").textbox('setValue',selectRow.sn).textbox('readonly',true);
                    $("#edit_course").textbox('setValue', selectRow.course);
                    $("#edit_grade").textbox('setValue', selectRow.grade);
                    $("#edit_credit").textbox('setValue', selectRow.credit);
                    $("#edit_point").textbox('setValue', selectRow.point);
                }
            });

            //设置导入窗口
            $("#importDialog").dialog({
                title: "导入成绩",
                width: 450,
                height: 150,
                iconCls: "icon-add",
                modal: true,
                collapsible: false,
                minimizable: false,
                maximizable: false,
                draggable: true,
                closed: true,
                buttons: [
                    {
                        text:'确认导入',
                        plain: true,
                        iconCls:'icon-book-add',
                        handler:function(){
                            var validate = $("#importForm").form("validate");
                            if(!validate){
                                $.messager.alert("消息提醒","请选择文件!","warning");
                                return;
                            } else{
                                // $("#importForm").submit();
                                $.messager.progress({text:'正在上传导入中...'});

                                setTimeout(function () {
                                    importScore();
                                },5000);

                                $("#importDialog").dialog("close");
                            }
                        }
                    }
                ]
            });

            //搜索按钮监听事件
            $("#search-btn").click(function () {
                $('#dataList').datagrid('load', {
                    studentid: $("#studentList").combobox('getValue') === '' ? 0 : $("#studentList").combobox('getValue'),
                    courseid: $("#courseList").combobox('getValue') === '' ? 0 : $("#courseList").combobox('getValue')
                });
            });

            //导出按钮监听事件
            $("#export").click(function () {
                studentid = $("#studentList").combobox('getValue') === '' ? 0 : $("#studentList").combobox('getValue');
                courseid = $("#courseList").combobox('getValue') === '' ? 0 : $("#courseList").combobox('getValue');
                url = [[@{/score/exportScore}]]+"?studentId=" + studentid + "&courseId=" + courseid;
                window.location.href = url;
            });

            //清空搜索条件
            $("#clear-btn").click(function () {
                $('#dataList').datagrid("reload", {});
                $("#studentList").combobox('clear');
                $("#courseList").combobox('clear');
            });

            function importScore() {
                var formData = new FormData($( "#importForm" )[0]);
                $.ajax({
                    type: "post",
                    url: [[@{/score/importScore}]],
                    data: formData,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function(data){
                    if(data.success){

                        $.messager.progress('close');
                        $.messager.alert("消息提醒",data.message,"info");

                        //关闭窗口

                        $('#dataList').datagrid("reload");
                    } else{
                        $.messager.alert("消息提醒",data.message,"warning");
                    }
                }
            });
            }

        });
        /*]]>*/
    </script>
</head>
<body>
<!-- 数据列表 -->
<table id="dataList" cellspacing="0" cellpadding="0">

</table>
<!-- 工具栏 -->
<div id="toolbar">
    <div style="float: left"><a id="import" style="background-color: #9494e3" href="javascript:" class="easyui-linkbutton" data-options="iconCls:'icon-large-smartart',plain:true">导入</a></div>
    <div style="float: left;" class="datagrid-btn-separator"></div>
    <div style="float: left"><a id="export" style="background-color: #9494e3" href="javascript:" class="easyui-linkbutton" data-options="iconCls:'icon-print',plain:true">导出</a></div>
    <div style="float: left;" class="datagrid-btn-separator"></div>
    <div th:if="${session.usertype == '1' || session.usertype == '3'}" style="float: left;"><a id="add"
          href="javascript:;" class="easyui-linkbutton"data-options="iconCls:'icon-add',plain:true">添加</a>
    </div>
    <div style="float: left;" class="datagrid-btn-separator"></div>
    <div th:if="${session.usertype == '1' || session.usertype == '3'}" style="float: left;"><a id="edit"
         href="javascript:;" class="easyui-linkbutton" data-options="iconCls:'icon-edit',plain:true">修改</a>
    </div>
    <div style="float: left;" class="datagrid-btn-separator"></div>
    <div th:if="${session.usertype == '1' || session.usertype == '3'}" style="float: left; margin-right: 10px;"><a
            id="delete" href="javascript:;" class="easyui-linkbutton"
            data-options="iconCls:'icon-some-delete',plain:true">删除</a></div>
    <div style="float: left;" class="datagrid-btn-separator"></div>
    <div style="margin-top: 3px;">
        学生：<input id="studentList" class="easyui-textbox" name="studentList"/>
        课程：<input id="courseList" class="easyui-textbox" name="courseList"/>
        <a id="search-btn" href="javascript:;" class="easyui-linkbutton"
           data-options="iconCls:'icon-search',plain:true">搜索</a>
        <a id="clear-btn" href="javascript:;" class="easyui-linkbutton" data-options="iconCls:'icon-search',plain:true">清空搜索</a>
        <a id="set" style="background-color: #9494e3" href="javascript:" class="easyui-linkbutton"
           data-options="iconCls:'icon-edit',plain:true">设置评奖资格</a>
    </div>
    <!--    <div th:if="${session.usertype == '1'}" style="float: right;"><a id="apply" style="background-color: #9494e3" href="javascript:" class="easyui-linkbutton" data-options="iconCls:'icon-edit',plain:true">设置评奖资格</a></div>-->
</div>

<!-- 添加数据窗口 -->
<div id="addDialog" style="padding: 10px">
    <form id="addForm" method="post">
        <table cellpadding="8">
            <tr>
                <td style="width:40px">学号:</td>
                <td colspan="3">
                    <input id="add_sn" style="width: 200px; height: 30px;" class="easyui-textbox"
                           data-options="required:true, missingMessage:'请选择学号'"
                           name="sn"/>
                </td>
                <td style="width:80px"></td>
            </tr>
            <tr>
                <td style="width:40px">课程:</td>
                <td colspan="3">
                    <input id="add_course" style="width: 200px; height: 30px;" class="easyui-textbox"
                           name="course" data-options="required:true, missingMessage:'请填写课程'"/>
                </td>
                <td style="width:80px"></td>
            </tr>

            <tr>
                <td style="width:40px">分数:</td>
                <td colspan="3">
                    <input id="add_grade" style="width: 200px; height: 30px;" class="easyui-numberbox"
                           data-options="required:true,min:0,precision:1, missingMessage:'请填写正确的分数'" name="grade"/>
                </td>
                <td style="width:80px"></td>
            </tr>
            <tr>
                <td style="width:40px">学分:</td>
                <td colspan="3">
                    <input id="add_credit" style="width: 200px; height: 30px;" class="easyui-numberbox"
                           data-options="required:true,min:0,precision:1, missingMessage:'请填写正确的学分'" name="credit"/>
                </td>
                <td style="width:80px"></td>
            </tr>
            <tr>
                <td style="width:40px">绩点:</td>
                <td colspan="3">
                    <input id="add_point" style="width: 200px; height: 30px;" class="easyui-numberbox"
                           data-options="required:true,min:0,precision:2, missingMessage:'请填写正确的绩点'" name="point"/>
                </td>
                <td style="width:80px"></td>
            </tr>

        </table>
    </form>
</div>

<div id="setDialog" style="padding: 10px">
    <form id="setForm" method="post">
        <table cellpadding="8">
            <tr>
                <td>成绩:</td>
                <td><select id="add_level" class="easyui-combobox"
                            data-options="editable: false, panelHeight: 50, width: 200, height: 30" name="level">
                    <option value="1.0">及格</option>
                    <option value="2.0">一般</option>
                    <option value="3.0">优秀</option>
                </select></td>
            </tr>
        </table>
    </form>
</div>

<!-- 修改数据窗口 -->
<div id="editDialog" style="padding: 10px">
    <form id="editForm" method="post">
        <table cellpadding="8">
            <tr>
                <td style="width:40px">学号:</td>
                <td colspan="3">
                    <input id="edit_sn" style="width: 200px; height: 30px;" class="easyui-textbox"
                           name="sn"/>
                </td>
                <td style="width:80px"></td>
            </tr>
            <tr>
                <td style="width:40px">课程:</td>
                <td colspan="3">
                    <input id="edit_course" style="width: 200px; height: 30px;" class="easyui-textbox"
                           name="course" data-options="required:true, missingMessage:'请选择课程'"/>
                </td>
                <td style="width:80px"></td>
            </tr>

            <tr>
                <td style="width:40px">分数:</td>
                <td colspan="3">
                    <input id="edit_grade" style="width: 200px; height: 30px;" class="easyui-numberbox"
                           data-options="required:true,min:0,precision:1, missingMessage:'请填写正确的分数'" name="grade"/>
                </td>
                <td style="width:80px"></td>
            </tr>
            <tr>
                <td style="width:40px">学分:</td>
                <td colspan="3">
                    <input id="edit_credit" style="width: 200px; height: 30px;" class="easyui-numberbox"
                           data-options="required:true,min:0,precision:1, missingMessage:'请填写正确的学分'" name="credit"/>
                </td>
                <td style="width:80px"></td>
            </tr>
            <tr>
                <td style="width:40px">绩点:</td>
                <td colspan="3">
                    <input id="edit_point" style="width: 200px; height: 30px;" class="easyui-numberbox"
                           data-options="required:true,min:0,precision:2, missingMessage:'请填写正确的绩点'" name="point"/>
                </td>
                <td style="width:80px"></td>
            </tr>
        </table>
    </form>
</div>

<!-- 导入数据窗口 -->
<div id="importDialog" style="padding: 10px">
    <form id="importForm" method="post" enctype="multipart/form-data" >
        <table cellpadding="8" >
            <tr>
                <td>请选择文件:</td>
                <td><input class="easyui-filebox" name="importScore" multiple data-options="required:true,min:0,precision:2, missingMessage:'请选择文件',prompt:'选择文件'" style="width:200px;"></td>

            </tr>
        </table>
    </form>
</div>
<!-- 提交表单处理iframe框架 -->
<iframe id="import_target" name="import_target"></iframe>
</body>
</html>